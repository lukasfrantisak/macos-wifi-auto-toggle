#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import time
from config import *
from net_utils import get_hw_ports, get_wifi_device, get_wifi_service, get_current_ssid, wired_really_active
from wifi_control import wifi_set_power
from notify import notify

def main():
    last_switch_ts = 0.0
    last_wifi_state = None

    while True:
        hw = get_hw_ports()
        wifi_dev = get_wifi_device(hw)
        wifi_service = get_wifi_service()
        ssid = get_current_ssid(wifi_dev)
        wired_active = wired_really_active(hw)
        in_office = bool(ssid and ssid in OFFICE_SSIDS)
        now = time.time()

        print(f"[gate] SSID='{ssid or '-'}' in_office={in_office} wired_active={wired_active}", flush=True)

        if wired_active:
            # Drát připojen → Wi-Fi vypnout
            if last_wifi_state is not False:
                wifi_set_power(wifi_service or wifi_dev, False)
                notify("Wi-Fi Auto Toggle", "Drátové připojení aktivní – vypínám Wi-Fi.")
                last_wifi_state = False
        else:
            # Drát odpojen → Wi-Fi zapnout
            if last_wifi_state is not True:
                wifi_set_power(wifi_service or wifi_dev, True)
                notify("Wi-Fi Auto Toggle", "Drát odpojen – zapínám Wi-Fi.")
                last_wifi_state = True

        # Mimo kancelář → spánek
        if not in_office and not wired_active:
            print(f"[idle] mimo kancelář → spím {IDLE_SLEEP_SECONDS}s")
            time.sleep(IDLE_SLEEP_SECONDS)
            continue

        time.sleep(3)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n[exit] Ukončeno uživatelem.")